@page
@model EnableAuthenticatorModel
@{
    ViewData["Title"] = "Cấu hình ứng dụng xác thực";
    ViewData["ActivePage"] = ManageNavPages.TwoFactorAuthentication;
    Layout = "/Areas/Identity/Pages/Account/Manage/_Layout.cshtml";
}

<div class="card shadow-sm border-0">
    <div class="card-header bg-primary text-white">
        <h4 class="mb-0">
            <i class="fas fa-shield-alt me-2"></i>@ViewData["Title"]
        </h4>
    </div>
    <div class="card-body p-4">

        <partial name="_StatusMessage" for="StatusMessage" />
        <p class="text-muted">Để sử dụng ứng dụng xác thực, vui lòng thực hiện các bước sau:</p>

        @* TÁI CẤU TRÚC LẠI CÁC BƯỚC HƯỚNG DẪN *@
        <div class="steps-container mt-4">

            @* BƯỚC 1: TẢI ỨNG DỤNG *@
            <div class="d-flex align-items-start mb-4">
                <div class="step-number me-3">1</div>
                <div>
                    <h5 class="fw-bold">Tải ứng dụng xác thực</h5>
                    <p class="mb-2">
                        Tải một ứng dụng xác thực hai yếu tố như Microsoft Authenticator cho
                        <a href="https://go.microsoft.com/fwlink/?Linkid=825072" target="_blank" rel="noopener noreferrer">Android</a> và
                        <a href="https://go.microsoft.com/fwlink/?Linkid=825073" target="_blank" rel="noopener noreferrer">iOS</a>;
                        hoặc Google Authenticator cho
                        <a href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&amp;hl=en" target="_blank" rel="noopener noreferrer">Android</a> và
                        <a href="https://itunes.apple.com/us/app/google-authenticator/id388497605?mt=8" target="_blank" rel="noopener noreferrer">iOS</a>.
                    </p>
                </div>
            </div>

            @* BƯỚC 2: QUÉT MÃ QR *@
            <div class="d-flex align-items-start mb-4">
                <div class="step-number me-3">2</div>
                <div>
                    <h5 class="fw-bold">Quét mã QR</h5>
                    <p class="mb-2">
                        Quét mã QR hoặc nhập thủ công khóa này vào ứng dụng xác thực của bạn.
                        <br>
                        (Viết hoa và khoảng trắng không quan trọng).
                    </p>
                    @* Khu vực hiển thị mã QR và khóa *@
                    <div class="qr-code-area p-3 bg-light rounded text-center my-3">
                        <div id="qrCode" class="mb-3 d-inline-block"></div>
                        <div id="qrCodeData" data-url="@Model.AuthenticatorUri"></div>
                        <div>
                            <span class="text-muted">Hoặc nhập khóa:</span>
                            <kbd class="font-monospace bg-dark text-white p-1 rounded">@Model.SharedKey</kbd>
                        </div>
                    </div>
                    <p class="small text-muted fst-italic">Nếu bạn không thấy mã QR, <a href="https://go.microsoft.com/fwlink/?Linkid=852423" target="_blank" rel="noopener noreferrer">hãy tìm hiểu cách bật tính năng này</a>.</p>
                </div>
            </div>

            @* BƯỚC 3: XÁC MINH MÃ *@
            <div class="d-flex align-items-start">
                <div class="step-number me-3">3</div>
                <div>
                    <h5 class="fw-bold">Nhập mã xác thực</h5>
                    <p class="mb-2">Sau khi quét, ứng dụng sẽ cung cấp cho bạn một mã gồm 6 chữ số. Hãy nhập mã đó vào ô xác nhận bên dưới.</p>

                    @* Form nhập mã xác thực *@
                    <form id="send-code" method="post" class="mt-3">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3" role="alert"></div>
                        <div class="form-floating mb-3">
                            <input asp-for="Input.Code" class="form-control" autocomplete="off" placeholder="Vui lòng nhập mã." />
                            <label asp-for="Input.Code" class="control-label form-label">Mã xác thực</label>
                            <span asp-validation-for="Input.Code" class="text-danger"></span>
                        </div>

                        @* Nút bấm xác minh và quay lại *@
                        <div class="d-grid gap-2 d-md-flex mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">Xác minh</button>
                            <a class="btn btn-secondary btn-lg text-white" asp-page="./TwoFactorAuthentication">Quay lại</a>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

@* THÊM CSS ĐỂ TRANG TRÍ SỐ THỨ TỰ CÁC BƯỚC *@
<style>
    .step-number {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        min-width: 36px; /* Để số không bị co lại */
        border-radius: 50%;
        background-color: #0d6efd; /* Màu xanh primary của Bootstrap */
        color: white;
        font-weight: bold;
        font-size: 1.1rem;
    }
</style>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    @* THÊM THƯ VIỆN ĐỂ TẠO MÃ QR *@
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script type="text/javascript">
        // Tạo mã QR từ dữ liệu trong thẻ div #qrCodeData
        new QRCode(document.getElementById("qrCode"), {
            text: document.getElementById("qrCodeData").getAttribute("data-url"),
            width: 150,
            height: 150
        });
    </script>
}