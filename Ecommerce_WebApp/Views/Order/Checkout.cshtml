@using Ecommerce_WebApp.ViewModels
@using Ecommerce_WebApp.Utility
@model CheckoutVM;

@{
    ViewData["Title"] = "Thông tin Thanh toán";
}

<div class="container my-5">
    <div class="text-center mb-5">
        <h1>@ViewData["Title"]</h1>
        <p class="text-muted">Vui lòng điền đầy đủ các thông tin dưới đây để hoàn tất đơn hàng.</p>
    </div>

    <!-- Form sẽ gửi dữ liệu đến Action Checkout (POST) -->
    <form method="post">
        <div class="row g-5">
            <!-- CỘT THÔNG TIN THANH TOÁN (BÊN TRÁI) -->
            <div class="col-lg-7">

                <!-- 1. Thông tin liên hệ và giao hàng -->
                <h4 class="mb-3">Địa chỉ giao hàng</h4>

                @* Hiển thị lỗi validation tổng hợp *@
                <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                <div class="row g-3">
                    <div class="col-12">
                        <label asp-for="OrderHeader.Email" class="form-label"></label>
                        <input type="email" asp-for="OrderHeader.Email" class="form-control" placeholder="you@example.com">
                        <span asp-validation-for="OrderHeader.Email" class="text-danger small"></span>
                    </div>
                    <div class="col-12">
                        <label asp-for="OrderHeader.FullName" class="form-label">Họ và Tên người nhận</label>
                        <input type="text" asp-for="OrderHeader.FullName" class="form-control" placeholder="Nguyễn Văn A" required>
                        <span asp-validation-for="OrderHeader.FullName" class="text-danger small"></span>
                    </div>
                    <div class="col-12">
                        <label asp-for="OrderHeader.PhoneNumber" class="form-label">Số điện thoại</label>
                        <input type="tel" asp-for="OrderHeader.PhoneNumber" class="form-control" placeholder="09xxxxxxxx" required>
                        <span asp-validation-for="OrderHeader.PhoneNumber" class="text-danger small"></span>
                    </div>
                    <div class="col-12">
                        <label asp-for="OrderHeader.Address" class="form-label">Số nhà, Tên đường</label>
                        <input type="text" asp-for="OrderHeader.Address" class="form-control" placeholder="123 Đường ABC" required>
                        <span asp-validation-for="OrderHeader.Address" class="text-danger small"></span>
                    </div>
                    <div class="col-md-4">
                        <label asp-for="OrderHeader.City" class="form-label">Tỉnh / Thành phố</label>
                        <select asp-for="OrderHeader.City" id="city" class="form-select" required>
                            <option value="" selected>Chọn Tỉnh/Thành</option>
                        </select>
                        <span asp-validation-for="OrderHeader.City" class="text-danger small"></span>
                    </div>
                    <div class="col-md-4">
                        <label asp-for="OrderHeader.District" class="form-label">Quận / Huyện</label>
                        <select asp-for="OrderHeader.District" id="district" class="form-select" required>
                            <option value="" selected>Chọn Quận/Huyện</option>
                        </select>
                        <span asp-validation-for="OrderHeader.District" class="text-danger small"></span>
                    </div>
                    <div class="col-md-4">
                        <label asp-for="OrderHeader.Ward" class="form-label">Phường / Xã</label>
                        <select asp-for="OrderHeader.Ward" id="ward" class="form-select" required>
                            <option value="" selected>Chọn Phường/Xã</option>
                        </select>
                        <span asp-validation-for="OrderHeader.Ward" class="text-danger small"></span>
                    </div>
                </div>

                <hr class="my-4">

                <h4 class="mb-3">Phương thức thanh toán</h4>
                <div class="my-3">

                    @* --- LỰA CHỌN 1: COD --- *@
                    <div class="form-check p-3 border rounded">
                        @* Dùng asp-for để binding vào thuộc tính PaymentMethod của ViewModel *@
                        <input asp-for="PaymentMethod" type="radio" class="form-check-input" value="@SD.PaymentMethodCOD" id="codPayment" checked>
                        <label class="form-check-label" for="codPayment">
                            <i class="fas fa-truck me-2"></i>Thanh toán khi nhận hàng (COD)
                        </label>
                    </div>

                    @* --- LỰA CHỌN 2: MOMO --- *@
                    <div class="form-check p-3 border rounded mt-2">
                        <input asp-for="PaymentMethod" type="radio" class="form-check-input" value="@SD.PaymentMethodMomo" id="momoPayment">
                        <label class="form-check-label" for="momoPayment">
                            @* Dùng logo của MoMo cho đẹp *@
                            <img src="~/img/logo-momo.png" height="20" alt="MoMo" class="me-2" />
                            Thanh toán qua Ví MoMo
                        </label>
                    </div>

                </div>

                <button id="checkoutButton" class="w-100 btn btn-primary btn-lg" type="submit">HOÀN TẤT ĐẶT HÀNG</button>
            </div>

            <!-- CỘT TÓM TẮT ĐƠN HÀNG (BÊN PHẢI) -->
            <div class="col-lg-5">
                <div class="card shadow-sm sticky-top" style="top: 2rem;">
                    <div class="card-header py-3">
                        <h4 class="my-0 fw-normal">Tóm tắt đơn hàng (@Model.ShoppingCart.Items.Sum(i => i.Quantity) sản phẩm)</h4>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            @* Vòng lặp foreach để hiển thị từng sản phẩm trong giỏ hàng *@
                            @foreach (var item in Model.ShoppingCart.Items)
                            {
                                <li class="list-group-item d-flex justify-content-between lh-sm">
                                    <div>
                                        <h6 class="my-0">@item.ProductName</h6>
                                        <small class="text-muted">SL: @item.Quantity</small>
                                    </div>
                                    <span class="text-muted">@item.SubTotal.ToString("N0")₫</span>
                                </li>
                            }

                            <li class="list-group-item d-flex justify-content-between">
                                <strong>Tổng cộng (VND)</strong>
                                <strong>@Model.ShoppingCart.Items.Sum(i => i.SubTotal).ToString("N0")₫</strong>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    @{
        <partial name="_ValidationScriptsPartial" />
    }
    <script>
        // === CHỈ SỬ DỤNG MỘT KHỐI DOCUMENT.READY DUY NHẤT ===
        $(document).ready(function() {

            // --- LOGIC CHO NÚT THANH TOÁN ---
            $('input[name="PaymentMethod"]').on('change', function() {
                var selectedMethod = $(this).val();
                var button = $('#checkoutButton');

                if (selectedMethod === '@SD.PaymentMethodMomo') {
                    button.text('TIẾP TỤC VỚI MOMO');
                } else {
                    button.text('HOÀN TẤT ĐẶT HÀNG');
                }
            });

            // =======================================================
            // == LOGIC LẤY ĐỊA CHỈ HÀNH CHÍNH (DÙNG FETCH API)
            // =======================================================
            const host = "https://provinces.open-api.vn/api/";

            var callAPI = (api) => {
                // Sử dụng fetch API của trình duyệt
                return fetch(api).then(response => response.json());
            }

            var renderData = (array, selectElementId) => {
                let select = document.getElementById(selectElementId);
                select.innerHTML = '<option value="" disabled selected>Vui lòng chọn</option>';
                array.forEach(element => {
                    let option = document.createElement('option');
                    option.dataset.code = element.code;
                    option.value = element.name;
                    option.textContent = element.name;
                    select.appendChild(option);
                });
                // Kích hoạt lại Select2 sau khi đã thêm các option
                 $('#' + selectElementId).trigger('change.select2');
            }

            // 1. Tải danh sách Tỉnh/Thành
            callAPI(host + "?depth=1").then(data => {
                renderData(data, "city");
            });

            // 2. Xử lý khi chọn Tỉnh/Thành
            $("#city").on("change", function () {
                const selectedOption = $(this).find('option:selected');
                const cityCode = selectedOption.data('code');
                callAPI(host + "p/" + cityCode + "?depth=2").then(data => {
                    renderData(data.districts, "district");
                    document.getElementById('ward').innerHTML = '<option value="" disabled selected>Vui lòng chọn</option>';
                    $('#district, #ward').trigger('change.select2'); // Reset cả 2
                });
            });

            // 3. Xử lý khi chọn Quận/Huyện
            $("#district").on("change", function () {
                const selectedOption = $(this).find('option:selected');
                const districtCode = selectedOption.data('code');
                 callAPI(host + "d/" + districtCode + "?depth=2").then(data => {
                    renderData(data.wards, "ward");
                });
            });

             // 4. Khởi tạo Select2 cho các dropdown
            $('#city, #district, #ward').select2({
                placeholder: "Vui lòng chọn...",
                allowClear: true
            });
        });
    </script>
}